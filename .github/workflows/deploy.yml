name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:

  security-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout-code
      uses: actions/checkout@v4
      # 1) Secret scanning / token scan (example: Gitleaks)
    - name: Security scan with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'      # Scan filesystem (your code)
        scan-ref: '.'        # Current directory
        format: 'sarif'      # GitHub SARIF support
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '0'  

    - name: Backend vulnerability scan  # Added npm audit
      run: |
        cd backend
        npm ci
        npm audit --audit-level=high

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: security-check
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and push backend
      run: |
        cd backend
        docker build -t ${{ secrets.DOCKER_USERNAME }}/rdgm-backend:latest .
        docker push ${{ secrets.DOCKER_USERNAME }}/rdgm-backend:latest
    
    - name: Build and push frontend
      run: |
        cd frontend
        docker build -t ${{ secrets.DOCKER_USERNAME }}/rdgm-frontend:latest .
        docker push ${{ secrets.DOCKER_USERNAME }}/rdgm-frontend:latest
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # Create .env file with secrets
          cat > /home/ubuntu/.env << 'EOF'
          MONGODB_URI=${{ secrets.MONGODB_URI }}
          ACCESS_TOKEN_SECRET=${{ secrets.ACCESS_TOKEN_SECRET }}
          REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }}
          ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
          AWS_REGION=${{ secrets.AWS_REGION }}
          NODE_ENV=${{ secrets.NODE_ENV }}
          EMAIL_USER=${{ secrets.EMAIL_USER }}
          EMAIL_PASS=${{ secrets.EMAIL_PASS }}
          PORT=5000
          EOF
          
          # Deploy containers
          docker pull ${{ secrets.DOCKER_USERNAME }}/rdgm-backend:latest
          docker pull ${{ secrets.DOCKER_USERNAME }}/rdgm-frontend:latest
          
          docker stop backend frontend || true
          docker rm backend frontend || true
          
          docker run --name backend --network prod-network -p 5000:5000 -d -v /home/ubuntu/uploads:/app/uploads --env-file /home/ubuntu/.env ${{ secrets.DOCKER_USERNAME }}/rdgm-backend:latest
          docker run --name frontend --network prod-network -p 3000:3000 -d -e NEXT_PUBLIC_API_URL=https://www.royaldgmart.com --memory=1g ${{ secrets.DOCKER_USERNAME }}/rdgm-frontend:latest
