name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:

  security-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout-code
      uses: actions/checkout@v4
      # 1) Secret scanning / token scan (example: Gitleaks)
    - name: Security scan with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'      # Scan filesystem (your code)
        scan-ref: '.'        # Current directory
        format: 'sarif'      # GitHub SARIF support
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '0'  


  build-and-deploy:
    runs-on: ubuntu-latest
    needs: security-check
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and push backend
      run: |
        cd backend
        docker build -t ${{ secrets.DOCKER_USERNAME }}/rdgm-backend:latest .
        docker push ${{ secrets.DOCKER_USERNAME }}/rdgm-backend:latest
    
    - name: Build and push frontend
      run: |
        cd frontend
        docker build --build-arg NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }} --build-arg NEXT_PUBLIC_RAZORPAY_KEY_ID=${{ secrets.NEXT_PUBLIC_RAZORPAY_KEY_ID }} -t ${{ secrets.DOCKER_USERNAME }}/rdgm-frontend:latest .
        docker push ${{ secrets.DOCKER_USERNAME }}/rdgm-frontend:latest
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        command_timeout: 30m
        script: |
          docker pull ${{ secrets.DOCKER_USERNAME }}/rdgm-backend:latest
          docker pull ${{ secrets.DOCKER_USERNAME }}/rdgm-frontend:latest
          
          # Stop and remove old containers
          docker stop backend frontend || true
          docker rm backend frontend || true
          
          # Run backend with direct environment variables
          docker run --name backend --network prod-network -p 5000:5000 -d \
            -v /home/ubuntu/uploads:/app/uploads \
            -e MONGODB_URI="${{ secrets.MONGODB_URI }}" \
            -e ACCESS_TOKEN_SECRET="${{ secrets.ACCESS_TOKEN_SECRET }}" \
            -e REFRESH_TOKEN_SECRET="${{ secrets.REFRESH_TOKEN_SECRET }}" \
            -e ADMIN_EMAIL="${{ secrets.ADMIN_EMAIL }}" \
            -e AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
            -e AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
            -e S3_BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}" \
            -e AWS_REGION="${{ secrets.AWS_REGION }}" \
            -e NODE_ENV="${{ secrets.NODE_ENV }}" \
            -e EMAIL_USER="${{ secrets.EMAIL_USER }}" \
            -e EMAIL_PASS="${{ secrets.EMAIL_PASS }}" \
            -e RAZORPAY_KEY_ID="${{ secrets.RAZORPAY_KEY_ID }}" \
            -e RAZORPAY_KEY_SECRET="${{ secrets.RAZORPAY_KEY_SECRET }}" \
            -e PORT=5000 \
            ${{ secrets.DOCKER_USERNAME }}/rdgm-backend:latest
          
          # Run frontend with direct environment variables
          docker run --name frontend --network prod-network -p 3000:3000 -d \
            --memory=1g \
            -e NEXT_PUBLIC_API_URL="${{ secrets.NEXT_PUBLIC_API_URL }}" \
            -e NEXT_PUBLIC_RAZORPAY_KEY_ID="${{ secrets.NEXT_PUBLIC_RAZORPAY_KEY_ID }}" \
            ${{ secrets.DOCKER_USERNAME }}/rdgm-frontend:latest
          
          echo "Deployment successful"
